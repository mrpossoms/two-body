<html>
<head>
<link href="css/style.css" rel="stylesheet">
<link href="css/bootstrap.min.css" rel="stylesheet">
<script type="text/javascript" src="js/g.js"></script>
<script type="text/javascript" src="js/g.web.js"></script>
<script type="text/javascript" src="js/elements.js"></script>
<script type="text/javascript">

const k = {
    mouse: {
        sensitivity: 0.01,
    },
};


var view_q = [].quat_rotation([1, 0, 0], Math.PI * 0.6);
var cam = new g.web.gfx.camera();
var mouse_down = false;
var t = 0;
var el = new orbital_elements();


function element(id) { return document.getElementById(id); }

function on_load()
{
const base = window.location.pathname.replace('index.html', '');
const asset_list = [
	base + 'shaders/basic_textured.vert',
	base + 'shaders/basic_textured.frag',
    base + 'shaders/basic_color.vert',
    base + 'shaders/basic_color.frag',
    base + 'shaders/body.vert',
    base + 'shaders/body.frag',
	base + 'meshes/exported-cube.json',
    base + 'meshes/plane.json',
	base + 'imgs/stars.jpg',
];

function do_on_change(e)
{
    if (!e.attributes) { return; }

    for (var k in e.attributes)
    {
        const attr = e.attributes[k];
        if (attr.name !== 'on-change') { continue; }

        const functions = attr.value.split(' ');

        for (var i = functions.length; i--;)
        {
            eval(functions[i]);
        }

        return;
    }
}

el.control.for_prop('el.i', 'i');
el.control.for_prop('el.i-text', 'i');
el.control.for_prop('el.e', 'e');
el.control.for_prop('el.e-text', 'e');
el.control.for_prop('el.ω', 'ω');
el.control.for_prop('el.ω-text', 'ω');
el.control.for_prop('el.Ω', 'Ω');
el.control.for_prop('el.Ω-text', 'Ω');
el.control.for_prop('el.ν', 'ν');
el.control.for_prop('el.ν-text', 'ν');

el.control.for_prop('el.r0[0]', 'r0[0]');
el.control.for_prop('el.r0[1]', 'r0[1]');
el.control.for_prop('el.r0[2]', 'r0[2]');

el.control.for_prop('el.v0[0]', 'v0[0]');
el.control.for_prop('el.v0[1]', 'v0[1]');
el.control.for_prop('el.v0[2]', 'v0[2]');

el.compute.elements_from_vectors();

g.web.canvas(document.getElementsByTagName('canvas')[0], {fixed_size: false});

g.initialize(function ()
{
    g.is_running = false;


    g.web.assets.load(asset_list,
    function() {
        g.web.gfx.shader.create('basic_textured',
            g.web.assets[base + 'shaders/basic_textured.vert'],
            g.web.assets[base + 'shaders/basic_textured.frag']
        );

        g.web.gfx.shader.create('body',
            g.web.assets[base + 'shaders/body.vert'],
            g.web.assets[base + 'shaders/body.frag']
        );

        g.web.gfx.shader.create('basic_color',
            g.web.assets[base + 'shaders/basic_color.vert'],
            g.web.assets[base + 'shaders/basic_color.frag']
        );

        g.is_running = true;

        gl.enable(gl.BLEND);
        gl.blendFunc(gl.SRC_ALPHA, gl.ONE_MINUS_SRC_ALPHA);
        gl.lineWidth(1);

        g.web.assets['mesh/point'] = g.web.gfx.mesh.create({ positions: [0, 0, 0]});

        g.web.assets['mesh/basis'] = g.web.gfx.mesh.create({
            positions: [
                0, 0, 0, 1, 0, 0,
                0, 0, 0, 0, 1, 0,
                0, 0, 0, 0, 0, 1,
            ],
            colors: [
                1, 0, 0, 1, 1, 0, 0, 1,
                0, 1, 0, 1, 0, 1, 0, 1,
                0, 0, 1, 1, 0, 0, 1, 1,
            ]
        });

        g.web.assets['mesh/line'] = g.web.gfx.mesh.create({
            positions: [ 0, 0, 0, 1, 0, 0, ],
            colors: [ 1, 1, 1, 0.5, 1, 1, 1, 0.5, ]
        });
    },
    function(complete) {
        document.getElementById('server_msg').innerText = Math.ceil(100 * complete) + '%';
    });

	return true;
});


g.web.pointer.on_move(function (event)
{
    if (g.is_running == false) { return; }

    if (!mouse_down) { return; }

    const dqx = [].quat_rotation([0, 1, 0], event.movementX * k.mouse.sensitivity);
    const dqy = [].quat_rotation([1, 0, 0], event.movementY * k.mouse.sensitivity);
    const dq = dqx.quat_mul(dqy);

    view_q = view_q.quat_mul(dq);
});

g.web.pointer.on_press(function (e) { mouse_down = true; });

g.web.pointer.on_release(function (e) { mouse_down = false; });


function update_camera(camera, focus, q, dist, dt)
{
    camera.position = [0, 0, el.p() * 2];
    camera.look_at(camera.position, [0, 0, 0], [0, 1, 0]);
}

function draw_body(position, mass, light_dir)
{
    const model = [].scale(mass).mat_mul([].translate(position.mul(-1)));

    gl.enable(gl.DEPTH_TEST);
    g.web.assets['mesh/point'].using_shader('body')
                         .with_attribute({name:'a_position', buffer: 'positions', components: 3})
                         .set_uniform('u_proj').mat4(cam.projection())
                         .set_uniform('u_view').mat4(view_q.quat_to_matrix().mat_mul(cam.view()))
                         .set_uniform('u_model').mat4(model)
                         .set_uniform('u_rot').mat4(view_q.quat_to_matrix())
                         .set_uniform('u_mass').float(mass)
                         .set_uniform('u_light_dir').vec3(light_dir)
                         .draw_points();
}

function draw_skybox()
{
    g.web.assets[base + 'mesh/exported-cube'].using_shader('basic_textured')
                             .with_attribute({name:'a_position', buffer: 'positions', components: 3})
                             .with_attribute({name:'a_tex_coord', buffer: 'texture_coords', components: 2})
                             .set_uniform('u_proj').mat4(cam.projection())
                             .set_uniform('u_view').mat4(view_q.quat_inverse().quat_to_matrix())
                             .set_uniform('u_model').mat4([].scale(500))
                             .set_uniform('u_texture').texture(g.web.assets[base + 'tex/stars'])
                             .draw_tris();
    gl.enable(gl.DEPTH_TEST);
}

function draw_basis()
{
    gl.lineWidth(10);
    g.web.assets['mesh/basis'].using_shader('basic_color')
                             .with_attribute({name:'a_position', buffer: 'positions', components: 3})
                             .with_attribute({name:'a_color', buffer: 'colors', components: 4})
                             .set_uniform('u_proj').mat4(cam.projection())
                             .set_uniform('u_view').mat4(view_q.quat_to_matrix().mat_mul(cam.view()))
                             .set_uniform('u_model').mat4([].scale(2))
                             .draw_lines();
}

function draw_line(p0, p1, color)
{
    gl.lineWidth(2);
    const line = g.web.assets['mesh/line'];

    line.buffer('positions').set_data([p0, p1]);
    line.buffer('colors').set_data(color.concat(color));

    line.using_shader('basic_color')
        .with_attribute({name:'a_position', buffer: 'positions', components: 3})
        .with_attribute({name:'a_color', buffer: 'colors', components: 4})
        .set_uniform('u_proj').mat4(cam.projection())
        .set_uniform('u_view').mat4(view_q.quat_to_matrix().mat_mul(cam.view()))
        .set_uniform('u_model').mat4([].scale(1))
        .draw_lines();
}

function draw_orbit(path_func, steps, dt)
{
    gl.lineWidth(2);
    steps = steps || 100;
    dt = dt || (Math.PI / (steps / 2));


    for (var s = 0; s < steps; ++s)
    {
        const t_0 = s * dt;
        const t_1 = (s + 1) * dt;
        const line = g.web.assets['mesh/line'];

        line.buffer('positions').set_data([path_func(t_0), path_func(t_1)]);
        line.buffer('colors').set_data([1, 1, 1, 0.5, 1, 1, 1, 0.5,]);

        line.using_shader('basic_color')
            .with_attribute({name:'a_position', buffer: 'positions', components: 3})
            .with_attribute({name:'a_color', buffer: 'colors', components: 4})
            .set_uniform('u_proj').mat4(cam.projection())
            .set_uniform('u_view').mat4(view_q.quat_to_matrix().mat_mul(cam.view()))
            .set_uniform('u_model').mat4([].scale(1))
            .draw_lines();
    }
}

g.web.draw(function (dt)
{
    if (g.is_running == false) { return; }
    gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);

    update_camera(cam, [0, 0, -1], view_q, 10, dt);
    cam.perspective(Math.PI / 3, 0.1, 1000);

    draw_skybox();

    const light_dir = [ -1, 0, 0 ].norm();

    function orbit_wrapper(t)
    {
        return el.r(t);
    }

    draw_body([0, 0, 0], 2.5, light_dir);
    draw_basis();

    draw_body(orbit_wrapper(t), 0.5, light_dir);
    draw_orbit(orbit_wrapper);

    gl.disable(gl.DEPTH_TEST);
    draw_line([0, 0, 0], el.r(t), [1, 0, 1, 1]);
    draw_line([0, 0, 0], el.h(t), [1, 1, 0 , 1]);
    draw_line(el.r(t), el.v(t).add(el.r(t)), [0, 1, 1, 1]);

    draw_line([0, 0, 0], el.r0, [1, 0, 1, 0.25]);
    // draw_line(el.r0, el.r0.add(el.v0), [0, 1, 1, 0.25]);

    draw_line([0, 0, 0], el.n().norm(), [0, 0, 1, 0.75]);
    draw_line([0, 0, 0], el.e_v, [0, 1, 1, 0.75]);
    gl.enable(gl.DEPTH_TEST);
    // draw_line([0, 0, 0], el.v0, [0, 1, 0 , 0.25]);
    // draw_line([0, 0, 0], el.e_v, [1, 1, 1 , 1]);

    t += dt;
});

g.start();
}

</script>
</head>

<body class="container-fluid bg-dark" onload="on_load()">
<h1 class="text-light">Orbital Elements Calculator</h1>
<section class="row">

<canvas class="col" style="max-height: 640px;"></canvas>

<section class="col-md text-light m-2">
    <!-- Argument of periapsis -->
    <div class="row">
        <h2 class="sm-col text-top" for="el.ω">ω</h2>
        <p class="col">Lorem ipsum dolor sit amet, consectetur adipiscing elit. Vivamus eu nulla porta, efficitur nisl eu, sollicitudin nulla.</p>
    </div>
    <div class="row">
        <input id="el.ω-text" type="number" class="sm-col text-light bg-dark" vectors_from_elements min="0" max="360" value="0">
        <input id="el.ω" type="range" class="col custom-range" vectors_from_elements min="0" max="360" value="0">
    </div>
    <hr class="border-light"></hr>

    <!-- true anomaly ν -->
    <div class="row">
        <h2 class="sm-col text-top" for="el.ν">ν</h2>
        <p class="col">Lorem ipsum dolor sit amet, consectetur adipiscing elit. Vivamus eu nulla porta, efficitur nisl eu, sollicitudin nulla.</p>
    </div>
    <div class="row">
        <input id="el.ν-text" type="number" class="sm-col text-light bg-dark" vectors_from_elements min="0" max="360" value="0">
        <input id="el.ν" type="range" class="col custom-range" vectors_from_elements min="0" max="360" value="0">
    </div>
    <hr class="border-light"></hr>

    <!-- longitude of ascending node -->
    <div class="row">
        <h2 class="sm-col text-top" for="el.Ω">Ω</h2>
        <p class="col">Lorem ipsum dolor sit amet, consectetur adipiscing elit. Vivamus eu nulla porta, efficitur nisl eu, sollicitudin nulla.</p>
    </div>
    <div class="row">
        <input id="el.Ω-text" type="number" class="sm-col text-light bg-dark" vectors_from_elements min="0" max="360" value="0">
        <input id="el.Ω" type="range" class="col custom-range" vectors_from_elements min="0" max="360" value="0">
    </div>
    <hr class="border-light"></hr>

    <!-- eccentricity -->
    <div class="row">
        <h2 class="sm-col text-top" for="el.e">e</h2>
        <p class="col">Lorem ipsum dolor sit amet, consectetur adipiscing elit. Vivamus eu nulla porta, efficitur nisl eu, sollicitudin nulla.</p>
    </div>
    <div class="row">
        <input id="el.e-text" type="number" class="sm-col text-light bg-dark" vectors_from_elements min="0" max="1" step="0.1" value="0">
        <input id="el.e" type="range" class="col custom-range" vectors_from_elements min="0" max="1" step="0.01" value="0">
    </div>
    <hr class="border-light"></hr>

    <!-- inclination -->
    <div class="row">
        <h2 class="sm-col text-top" for="el.i">i</h2>
        <p class="col">Lorem ipsum dolor sit amet, consectetur adipiscing elit. Vivamus eu nulla porta, efficitur nisl eu, sollicitudin nulla.</p>
    </div>
    <div class="row">
        <input id="el.i-text" type="number" class="sm-col text-light bg-dark" vectors_from_elements min="0" max="360" value="0">
        <input id="el.i" type="range" class="col custom-range" vectors_from_elements min="0" max="180" value="0">
    </div>
</section>

</section>

<!-- R0 vector -->
<section class="row">
<div class="col">
    <h2 class="float-left text-light text-right">r0 = {</h2>

    <input id="el.r0[0]" class="float-left text-light bg-dark axis" elements_from_vectors type="number" step="0.1" value="1">
    <h2 class="float-left text-light">, </h2>

    <input id="el.r0[1]" class="float-left text-light bg-dark axis" elements_from_vectors type="number" step="0.1" value="0">
    <h2 class="float-left text-light">, </h2>

    <input id="el.r0[2]" class="float-left text-light bg-dark axis" elements_from_vectors type="number" step="0.1" value="0">

    <h2 class="float-left text-light text-left">}</h2>
</div>
</section>

<!-- V vector -->
<section class="row">
<div class="col">
    <h2 class="float-left text-light text-right">v0 = {</h2>

    <input id="el.v0[0]" class="float-left text-light bg-dark axis" elements_from_vectors type="number" step="0.1" value="0">
    <h2 class="float-left text-light">, </h2>

    <input id="el.v0[1]" class="float-left text-light bg-dark axis" elements_from_vectors type="number" step="0.1" value="0">
    <h2 class="float-left text-light">, </h2>

    <input id="el.v0[2]" class="float-left text-light bg-dark axis" elements_from_vectors type="number" step="0.1" value="1">

    <h2 class="float-left text-light text-left">}</h2>
</div>
</section>


</body>
</html>
