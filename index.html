<html>
<head>
<link href="css/style.css" rel="stylesheet">
<script type="text/javascript" src="js/g.js"></script>
<script type="text/javascript" src="js/g.web.js"></script>
<script type="text/javascript">

const k = {
    mouse: {
        sensitivity: 0.01,
    },
};

var view_q = [0,0,0,1];
var cam = new g.web.gfx.camera();
var t = 0;

function on_load()
{
const base = window.location.pathname.replace('index.html', '');
const asset_list = [
	base + 'shaders/basic_textured.vert',
	base + 'shaders/basic_textured.frag',
    base + 'shaders/basic_textured.vert',
    base + 'shaders/basic_textured.frag',
    base + 'shaders/body.vert',
    base + 'shaders/body.frag',
	base + 'meshes/exported-cube.json',
    base + 'meshes/plane.json',
	base + 'imgs/stars.jpg',
];


g.web.canvas(document.getElementsByTagName('canvas')[0]);

g.initialize(function ()
{
    g.is_running = false;

    g.web.assets.load(asset_list,
    function() {
        g.web.gfx.shader.create('basic_textured',
            g.web.assets[base + 'shaders/basic_textured.vert'],
            g.web.assets[base + 'shaders/basic_textured.frag']
        );

        g.web.gfx.shader.create('body',
            g.web.assets[base + 'shaders/body.vert'],
            g.web.assets[base + 'shaders/body.frag']
        );

        g.is_running = true;

        gl.enable(gl.BLEND);
        gl.blendFunc(gl.SRC_ALPHA, gl.ONE_MINUS_SRC_ALPHA);
        gl.lineWidth(1);
    },
    function(complete) {
        document.getElementById('server_msg').innerText = Math.ceil(100 * complete) + '%';
    });

	return true;
});


g.web.pointer.on_move(function (event)
{
    if (g.is_running == false) { return; }


    const dqx = [].quat_rotation([0, 1, 0], event.movementX * k.mouse.sensitivity);
    const dqy = [].quat_rotation([1, 0, 0], -event.movementY * k.mouse.sensitivity);
    const dq = dqx.quat_mul(dqy);

    view_q = view_q.quat_mul(dq);
});

g.web.pointer.on_press(function ()
{

});


g.update(function (dt)
{

});


function update_camera(camera, focus, q, dist, dt)
{
    const forward = q.quat_rotate_vector([0, 0, 1]);
    var up = q.quat_rotate_vector([0, 1, 0]);

    camera.position = forward.mul(-dist);

    camera.look_at(camera.position, focus, up);
}

function draw_body(position, mass)
{
    const model = [].scale(mass).mat_mul([].translate(position));

    g.web.assets[base + 'mesh/plane'].using_shader('body')
                             .with_attribute({name:'a_position', buffer: 'positions', components: 3})
                             .with_attribute({name:'a_tex_coord', buffer: 'texture_coords', components: 2})
                             // .with_attribute({name:'a_normal', buffer: 'normals', components: 3})
                             .set_uniform('u_proj').mat4(cam.projection())
                             .set_uniform('u_view').mat4([].translate(cam.position.mul(-1)))
                             .set_uniform('u_model').mat4(model)
                             .draw_tris();
}

function draw_skybox()
{
    gl.disable(gl.DEPTH_TEST);
    g.web.assets[base + 'mesh/exported-cube'].using_shader('basic_textured')
                             .with_attribute({name:'a_position', buffer: 'positions', components: 3})
                             .with_attribute({name:'a_tex_coord', buffer: 'texture_coords', components: 2})
                             .set_uniform('u_proj').mat4(cam.projection())
                             .set_uniform('u_view').mat4(cam.view())
                             .set_uniform('u_model').mat4([].scale(500))
                             .set_uniform('u_texture').texture(g.web.assets[base + 'tex/stars'])
                             .draw_tris();
    gl.enable(gl.DEPTH_TEST);
}


g.web.draw(function (dt)
{
    if (g.is_running == false) { return; }
    gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);

    update_camera(cam, [0, 0, 0], view_q, Math.cos(t += dt) + 2, dt);
    cam.perspective(Math.PI / 3, 0.1, 1000);

    draw_skybox();



    draw_body([0, 0, 0], 1);
});

g.start();
}

</script>
</head>

<body style="margin:0" onload="on_load()">
<p id="server_msg"></p>
<canvas style="padding:0;margin:0;width:100%;height:100%"></canvas>
</body>
</html>
